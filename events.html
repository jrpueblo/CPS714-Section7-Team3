<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events Page</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts.js" defer></script>
  <style>
    
    #editModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    #editBox {
      background: white;
      padding: 20px;
      width: 300px;
      border-radius: 10px;
    }

    #editBox input, #editBox textarea {
      width: 100%;
      margin: 5px 0;
      padding: 5px;
    }

    #editBox button {
      margin-top: 10px;
    }

    #main {
      text-align: center;
      width: 60%;
      margin: 50px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .event {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    
    .event-button {
      background-color: #2d5be3;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      margin:10px;
    }

    .event-button:hover {
      background-color: #0056b3;
    }

    
  </style>

</head>

<body>
  <header>
    <h1>CampusConnect</h1>
    <nav>
      <ul>
        <li><a href="events.html" class="current">My Events</a></li>
        <li><a href="create.html" id="createEventsLink">Create Events</a></li>
        <li><a href="registerClub.html">Register as a Club Organizer!</a></li>
      </ul>
    </nav>
  </header>

  <section id="main">
    <h2>My Events</h2>
    <div id="events">
        <p>Loading events...</p>
    </div>

    
    <div id="editModal">
      <div id="editBox">
        <h3>Edit Event</h3>
        <input type="text" id="editTitle" placeholder="Event Title">
        <textarea id="editDescription" placeholder="Description"></textarea>
        <input type="datetime-local" id="editStart">
        <input type="datetime-local" id="editEnd">

        <button id="saveEdit">Save</button>
        <button id="cancelEdit">Cancel</button>
      </div>
    </div>
  </section>

  <footer>
      <p>&copy; 2025 CampusConnect. All rights reserved.</p>
  </footer>

  <script>
    const SUPABASE_URL = "https://mtjgmoctyzgfubkpsydg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10amdtb2N0eXpnZnVia3BzeWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2Mjc5MTksImV4cCI6MjA3NTIwMzkxOX0.9Ku1_VjUhsBUtHwPSiBCYAez8sWyhK0x6Hc2SVxpqnk";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditId = null;

    async function loadEvents() {
      const { data, error } = await supabaseClient
        .from('events')
        .select('*');

      const container = document.getElementById('events');
      container.innerHTML = '';

      if (error) {
        container.innerHTML = `<p>Error loading events: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p>No events found.</p>';
        return;
      }

      const sessionUser = JSON.parse(sessionStorage.getItem("userData") || "{}");
      const userEmail = sessionUser.email;
      

      data.forEach(event => {
        if(userEmail==event.createdBy){
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.innerHTML = `
          <strong>${event.title}</strong><br>
          ${event.description || ''}<br><br>
          <div><strong>Start Time:</strong> ${new Date(event.start_time).toLocaleString()}</div>
          <div><strong>End Time:</strong> ${event.end_time ? new Date(event.end_time).toLocaleString() : '-'}</div>
          <div><strong>Location: </strong>${event.location || ''}
          <br><br>
          <button class="event-button" onclick="openEdit(${event.id})">‚úèÔ∏è Edit</button>
          <button class="event-button" onclick="deleteEvent(${event.id})">üóëÔ∏è Delete</button>
          
        `;
        container.appendChild(eventDiv);
        }
        
      });
    }

    
    async function deleteEvent(id){
      if(!confirm('Are you sure you want to delete this event?')) return;
      
      const { error } = await supabaseClient
        .from('events')
        .delete()
        .eq('id', id);

      if(error){
        alert('Error deleting the event: ' + error.message);
      } else {
        alert('Event has been deleted');
        loadEvents(); 
      }
    }

    
    async function openEdit(id) {
      currentEditId = id;

      const { data, error } = await supabaseClient
        .from('events')
        .select('*')
        .eq('id', id)
        .single();

      if (error) {
        alert("Failed to load event.");
        return;
      }

   
      document.getElementById("editTitle").value = data.title;
      document.getElementById("editDescription").value = data.description || "";
      document.getElementById("editStart").value = data.start_time ? data.start_time.slice(0, 16) : "";
      document.getElementById("editEnd").value = data.end_time ? data.end_time.slice(0, 16) : "";

      document.getElementById("editModal").style.display = "flex";
    }

    
    document.getElementById("saveEdit").addEventListener("click", async () => {
      const updated = {
        title: document.getElementById("editTitle").value,
        description: document.getElementById("editDescription").value,
        start_time: document.getElementById("editStart").value,
        end_time: document.getElementById("editEnd").value
      };

      const { error } = await supabaseClient
        .from("events")
        .update(updated)
        .eq("id", currentEditId);

      if (error) {
        alert("Failed to update event: " + error.message);
        return;
      }

      document.getElementById("editModal").style.display = "none";
      loadEvents();
      alert("Event updated!");
    });

    
    document.getElementById("cancelEdit").addEventListener("click", () => {
      document.getElementById("editModal").style.display = "none";
    });

    loadEvents();
  </script>
</body>
</html>
